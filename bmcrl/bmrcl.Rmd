---
title: "Bengaluru Metro"
author: "Ravi Gadepalli" 
output: 
  html_document:
    number_sections: true
---

```{r echo=F}
knitr::opts_chunk$set(message = FALSE, warning = F, echo = F )
```


```{r echo=F, message=F, warning=FALSE}
library(magrittr)
library(dplyr)
library(tidyr)
library(dodgr)
library(sf)
library(readxl)
library(ggplot2)
library(RColorBrewer)
library(stplanr)
library(viridis)
library(decoupleR)
```

```{r allcode, cache=TRUE, echo=F, warning=F, message=F  }
Daily_Traffic_Movement_CST_Aug_2022 <- read_excel("../../Data/Daily Traffic Movement_CSC & CST_for the month of Aug 2022.xlsx",
                                                  sheet = "daily traffic movement_CST")





Daily_Traffic_Movement_CSC_Aug_2022 <- read_excel("../../Data/Daily Traffic Movement_CSC & CST_for the month of Aug 2022.xlsx")





dailyCSCAug2022 <- pivot_longer(data=Daily_Traffic_Movement_CSC_Aug_2022, cols = 3:53) %>%
  rename(Origin = STATION, Destination = name, trips = value) %>%
  group_by(DATETIME, Origin, Destination) %>%
  summarise(TOTtrips = sum(trips)) %>%
  separate(DATETIME,c("year", "month", "day", "fromHr", "toHr"), "-" )  %>%
  mutate(across(c(1,2,3,4,5),readr::parse_number), calendar = lubridate::ymd(paste(year, month, day, "-")), pair = paste(Origin, Destination, sep = "-")) %>%
  select(-c(1:3))



dailyCSTAug2022 <- pivot_longer(data=Daily_Traffic_Movement_CST_Aug_2022, cols = 3:53) %>%
  rename(Origin = STATION, Destination = name, trips = value) %>%
  group_by(DATETIME, Origin, Destination) %>%
  summarise(TOTtrips = sum(trips)) %>%
  separate(DATETIME,c("year", "month", "day", "fromHr", "toHr"), "-" )  %>%
  mutate(across(c(1,2,3,4,5),readr::parse_number), calendar = lubridate::ymd(paste(year, month, day, "-")), pair = paste(Origin, Destination, sep = "-")) %>%
  select(-c(1:3))

rm(Daily_Traffic_Movement_CST_Aug_2022)
rm(Daily_Traffic_Movement_CSC_Aug_2022)


# READ STATION LOCATIONS

latlong <- read.csv("../stationLatLong.csv")

# COMBINE STATION LAT LONG TO MATRIX OF TRIPS

csc <- dplyr::left_join(x= dailyCSCAug2022, y = latlong, by = c("Origin" = "abbrev")) %>%
  rename(from_long = long, from_lat = lat) %>%
  dplyr::left_join(x= ., y = latlong, by = c("Destination" = "abbrev")) %>%
  rename(to_long = long, to_lat = lat)

cst <- dplyr::left_join(x= dailyCSTAug2022, y = latlong, by = c("Origin" = "abbrev")) %>%
  rename(from_long = long, from_lat = lat) %>%
  dplyr::left_join(x= ., y = latlong, by = c("Destination" = "abbrev")) %>%
  rename(to_long = long, to_lat = lat)

csc %>% group_by(OBJECTID.x) %>%  arrange(OBJECTID.x) %>% filter(row_number ()==1) -> csc_from
csc %>% group_by(OBJECTID.y) %>%  arrange(OBJECTID.y) %>% filter(row_number ()==1) -> csc_to

csc %>% group_by(OBJECTID.x) %>%  arrange(OBJECTID.x) %>% filter(row_number ()==1) -> cst_from
csc %>% group_by(OBJECTID.y) %>%  arrange(OBJECTID.y) %>% filter(row_number ()==1) -> cst_to

#dist <- dodgr::dodgr_dists(metro_graph, from = dffrom[,c("from_long", "from_lat")],to = dfto[,c("to_long", "to_lat")])

#flows <- array (runif (5 * 3), dim = c (5, 3))


# find date - time combinations that have full 51*51 = 2601 od pairs
csc_2601units <- dailyCSCAug2022 %>%  
  mutate(weekday = lubridate::wday(calendar,label = T) ) %>%
  filter(  weekday %in% c('Mon', 'Tue', 'Wed' , 'Thu' , 'Fri')) %>%
  group_by(calendar, fromHr) %>%
  tally() %>% filter(n==2601) %>%
  mutate(uniqueid = paste(as.character(calendar), "-", fromHr, sep = "" ))
cst_2601units <- dailyCSTAug2022 %>%  
  mutate(weekday = lubridate::wday(calendar,label = T) ) %>%
  filter(  weekday %in% c('Mon', 'Tue', 'Wed' , 'Thu' , 'Fri')) %>%
  group_by(calendar,fromHr) %>%
  tally() %>% filter(n==2601) %>%
  mutate(uniqueid = paste(as.character(calendar), "-", fromHr, sep = "" ))


# find common date time
common_date_time_CSC <-  csc_2601units %>% filter(uniqueid %in%  intersect(csc_2601units$uniqueid, cst_2601units$uniqueid))
common_date_time_CST <-  cst_2601units %>% filter(uniqueid %in%  intersect(csc_2601units$uniqueid, cst_2601units$uniqueid))


# filter trips for common date times


CSC_common_date_time_tables <- dailyCSCAug2022 %>%
  mutate(uniqueid = paste(as.character(calendar), "-", fromHr, sep = "" )) %>%
  filter(uniqueid %in% common_date_time_CSC$uniqueid)

CST_common_date_time_tables <- dailyCSTAug2022 %>%
  mutate(uniqueid = paste(as.character(calendar), "-", fromHr, sep = "" )) %>%
  filter(uniqueid %in% common_date_time_CST$uniqueid)

# remove intermediate variables
rm(common_date_time_CSC, common_date_time_CST)
rm(csc_2601units, cst_2601units)

# check if there are all pairs of ods'
cs <- CSC_common_date_time_tables %>% group_by(calendar, fromHr) %>% tally()
ct <- CST_common_date_time_tables %>% group_by(calendar, fromHr) %>% tally()

# create a matrix for each hour
# install.packages("BiocManager")
# BiocManager::install("decoupleR")
library(decoupleR)

Hour_of_Day <- "6" # later make this a variable
Date_of_Month <- "2022-08-01" # later make this a a variable
filterID <- paste(as.character(Date_of_Month), "-", Hour_of_Day, sep = "" )


CST_common_date_time_tables %>% filter(uniqueid == filterID) %>%
  pivot_wider_profile(names_from = Destination, id_cols = Origin, values_from = TOTtrips, to_matrix = T) -> cst_matrix

CSC_common_date_time_tables %>% filter(uniqueid == filterID) %>%
  pivot_wider_profile(names_from = Destination, id_cols = Origin, values_from = TOTtrips, to_matrix = T) -> csc_matrix



```

```{r results = 'hide' }
# BUILD DODGR GRAPH
metro <- sf::st_read("../../Data/GIS/lines12.shp")
metro_graph <- weight_streetnet(metro, wt_profile = "foot" , id_col = "id", type_col = "highway",
                                wt_profile_file = "../../Data/GIS/wtp.json")
``` 

```{r echo=F}
sorted_stations <- latlong %>% arrange(abbrev) %>% mutate(OBJECTID = row_number())

from <- sorted_stations[,c("long", "lat")]
to <- sorted_stations[,c("long", "lat")]

df <- dodgr_flows_aggregate (graph = metro_graph, from = from, to = to, flows = cst_matrix, norm_sums = F)

sf_f <- dodgr::dodgr_to_sf(df)
# sf::st_write(sf_f, "CCcst6am.shp", delete_layer = T )


# PLOT NETWORK

# library (mapdeck)
# mapdeck (style = mapdeck_style ()) %>%
#   add_line (metro_graph, 
#             origin = c ("from_lon", "from_lat"),
#             destination = c ("to_lon", "to_lat"),
#             stroke_colour = "flow", stroke_width = "flow",
#             stroke_opacity = "flow",
#             palette = "matlab_like2", legend = TRUE)

# CONVERT PROJECTION

p_sf <- sf::st_transform(sf_f, crs = 3857)

#  TRY TO GET A BUFFER ON SF

buffer_f <- p_sf %>% st_buffer( ., dist = .$flow, singleSide = T)
# plot(buffer_f$geometry)

library(ggplot2)
library(geomtextpath)

# k <-ggplot(data=sf_f) + geom_sf(data=sf_f,aes( fill =  flow) ) +
#   geom_textsf(data=sf_f,aes(label = flow),  vjust = -0.8, size = 5)
# 
# k
# 
# 
# 
# g_sf <- st_transform(buffer_f, crs = 4326)
# g <-ggplot(data=g_sf) + geom_sf(data=g_sf,aes( fill =  flow) ) +
#   geom_textsf(data=g_sf,aes(label = flow),  vjust = -0.8, size = 4)
# 
# g


# plot(buffer_f[,"flow"])


# plotting works======
library(stplanr)

l_f <- line_bearing(sf_f, bidirectional = F)

buffer_f$angle <- l_f

 # ggplot() + geom_sf(data = buffer_f, aes(fill = flow)) +
 #  geom_sf_text(data = buffer_f, aes(label = round(flow,1), angle = ifelse(angle >=0,90-angle,abs(angle)-90),family="sans",size = 8))+
 #  
 #  
 #  scale_fill_gradient(
 #    
 #    low = "pink",
 #    high = "red",
 #    space = "Lab",
 #    na.value = "grey50",
 #    guide = "colourbar",
 #    aesthetics = "fill"
 #  ) +
 #  theme_bw()

 
library(mapview) 
library(RColorBrewer)
#buffer_f %>% select(flow) %>% mapview::mapview(zcol = "flow", col.regions=brewer.pal(9, "YlGn"))

# buffer_f %>% select(flow) %>% mapview::mapview(zcol = "flow", col.regions=brewer.pal(10,"Reds"), popup = F)
```

# System-Wide Characteristics

---

##  Hourly Trends: Weekdays vs Public Holidays on Smart Cards

The public holidays include Moharam(9), RakshaBandhan (11), Independence Day (15), Janmashtami(19), Ganesh Chaturthi (31).

```{r }
# hourly data based on weekdays, 
library(magrittr)
library(dplyr)
hourly_day <- dailyCSCAug2022 %>% 
  mutate(weekday = lubridate::wday(calendar, label = T), 
         Date_of_Month=lubridate::day(calendar),
         TypeofDay = if_else(Date_of_Month %in% c(9,11,15,19,31),"Holiday", as.character(weekday)),
         TimePeriod = case_when(fromHr %in% c(8,9,10) ~ 'AM', fromHr %in% c(16,17,18,19) ~ 'PM', TRUE ~ 'OffPeak')) 

hourly_day$seq = factor(hourly_day$TypeofDay, levels=c('Mon','Tue','Wed','Thu', 'Fri', 'Sat', 'Sun', 'Holiday'))


library(ggplot2)
ggplot(hourly_day, aes(x = fromHr, y = TOTtrips)) + geom_col() +
  facet_wrap(~seq) +
  ggtitle("Hourly Pattern (aggregation: month of August)") +
  labs(x= "Hour of the day", y = "Total Trips")



```

---

##  Peak vs Off Peak: Weekdays vs Public Holidays on Smart Cards


Morning Peak is 08:00-10:00 hrs, Evening Peak is 16:00-19:00 hrs 

```{r  warning=F, message=F, fig.width = 12, fig.height = 6}
local_data <- hourly_day %>% group_by(TypeofDay, seq,TimePeriod) %>% summarise(trips=sum(TOTtrips))
ggplot(local_data, aes(x=seq, y = trips, fill = seq))+ 
  geom_col()+
  scale_fill_viridis(discrete = TRUE)+
   scale_y_continuous(labels = scales::comma)+
  facet_wrap(~TimePeriod)+
  ggtitle("Time Periods (aggregation: month of August)") +
  labs(x= "Day of the Week", y = "Total Trips", fill = "Day")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size =10),
        strip.text.x = element_text(size = 15),
        panel.spacing = unit(1, "lines"))

```



##  Hourly Trends: Weekdays vs Public Holidays on Tokens

The public holidays include Moharam(9), RakshaBandhan (11), Independence Day (15), Janmashtami(19), Ganesh Chaturthi (31).

```{r }
# hourly data based on weekdays, 
library(magrittr)
library(dplyr)
hourly_day <- dailyCSTAug2022 %>% 
  mutate(weekday = lubridate::wday(calendar, label = T), 
         Date_of_Month=lubridate::day(calendar),
         TypeofDay = if_else(Date_of_Month %in% c(9,11,15,19,31),"Holiday", as.character(weekday)),
         TimePeriod = case_when(fromHr %in% c(8,9,10) ~ 'AM', fromHr %in% c(16,17,18,19) ~ 'PM', TRUE ~ 'OffPeak')) 

hourly_day$seq = factor(hourly_day$TypeofDay, levels=c('Mon','Tue','Wed','Thu', 'Fri', 'Sat', 'Sun', 'Holiday'))


library(ggplot2)
ggplot(hourly_day, aes(x = fromHr, y = TOTtrips)) + geom_col() +
  facet_wrap(~seq) +
  
  ggtitle("Hourly Pattern (aggregation: month of August)") +
  labs(x= "Hour of the day", y = "Total Trips")



```

---

##  Peak vs Off Peak: Weekdays vs Public Holidays on Tokens


Morning Peak is 08:00-10:00 hrs, Evening Peak is 16:00-19:00 hrs 

```{r  warning=F, message=F}
local_data <- hourly_day %>% group_by(TypeofDay, seq,TimePeriod) %>% summarise(trips=sum(TOTtrips))
ggplot(local_data, aes(x=seq, y = trips, fill = TimePeriod))+ 
  geom_col()+
   scale_y_continuous(labels = scales::comma)+
  facet_wrap(~TimePeriod)+
  ggtitle("Time Periods (aggregation: month of August)") +
  labs(x= "Day of the Week", y = "Total Trips")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size =10))
```




# Line Based Characteristics



##  Hourly Trends: Weekdays vs Public Holidays on Smart Cards

The public holidays include Moharam(9), RakshaBandhan (11), Independence Day (15), Janmashtami(19), Ganesh Chaturthi (31).


```{r}

# read lookup table

lookup_stations_line<- read.csv("../lookup.csv")


#Distance_Matrix_for_Phase_1_Phase_2 <- read_excel("Data/Distance Matrix - for Phase 1 & Phase-2.xlsx")
Distance_Matrix_for_Phase_1_Phase_2 <- read.csv("../distancematrix2.csv")




DistanceMatrix <- Distance_Matrix_for_Phase_1_Phase_2  %>%
  pivot_longer(cols = 2:52) %>%
  rename( Destination = name, distance = value) %>%
  left_join(x=., y= lookup_stations_line, by = c("Origin" = "MATRIX")) %>% 
  select(-c(1)) %>% rename(mat_Origin =OD, LineO= LINE) %>%
  left_join(x=., y= lookup_stations_line, by = c("Destination" = "MATRIX")) %>%
  select(-c(1)) %>% rename(mat_Destination =OD, LineD= LINE) %>%
  mutate(pair =  paste(mat_Origin, mat_Destination, sep = "-") ) %>%
  select(mat_Origin, LineO, mat_Destination, LineD, distance, pair)


dailyCSCAug2022_station_Line <- left_join(x=dailyCSCAug2022, y = DistanceMatrix, by = c("pair"="pair")) %>% mutate(sheet = "CSC")
dailyCSTAug2022_station_Line <- left_join(x=dailyCSTAug2022, y = DistanceMatrix, by = c("pair"="pair")) %>%  mutate(sheet = "CST")


combined_data_numeric <- rbind(dailyCSTAug2022_station_Line, dailyCSCAug2022_station_Line) %>% 
  mutate(calendar_date = lubridate::day(calendar) , dayofweek = lubridate::wday(calendar, label = T, week_start = 1), DIST = round(distance, digits = 1)) %>%
  select(calendar, calendar_date, Origin, Destination, fromHr, toHr, TOTtrips, LineO, LineD, DIST, sheet, dayofweek)%>% ungroup()%>%
  select(calendar, calendar_date, fromHr,  TOTtrips, LineO, LineD, DIST, sheet, dayofweek) %>%
  mutate( TypeofDay = if_else(calendar_date %in% c(9,11,15,19,31),"Holiday", as.character(dayofweek)),
TimePeriod = case_when(fromHr %in% c(8,9,10) ~ 'AM', fromHr %in% c(16,17,18,19) ~ 'PM', TRUE ~ 'OffPeak'))
```



```{r message=F, warning=F, echo=F}
# hourly data based on weekdays, 
library(magrittr)
library(dplyr)
hourly_day <- dailyCSCAug2022 %>% 
  mutate(weekday = lubridate::wday(calendar, label = T), 
         Date_of_Month=lubridate::day(calendar),
         TypeofDay = if_else(Date_of_Month %in% c(9,11,15,19,31),"Holiday", as.character(weekday)),
         TimePeriod = case_when(fromHr %in% c(8,9,10) ~ 'AM', fromHr %in% c(16,17,18,19) ~ 'PM', TRUE ~ 'OffPeak')) 

combined_data_numeric$seq = factor(combined_data_numeric$TypeofDay, levels=c('Mon','Tue','Wed','Thu', 'Fri', 'Sat', 'Sun', 'Holiday'))


library(ggplot2)
ggplot(combined_data_numeric %>% filter(sheet == "CSC") %>% group_by(TypeofDay, seq, TimePeriod, fromHr, LineO) %>% summarize(trips=sum(TOTtrips)), aes(x = fromHr, y = trips, col = LineO, group = LineO)) + geom_line() +
  #facet_grid(LineO~seq) +
  scale_color_manual(values = c("darkgreen", "purple"))+
  facet_wrap(~seq) +
  ggtitle("Hourly Pattern (aggregation: month of August)") +
  labs(x= "Hour of the day", y = "Total Trips", col = "Line of Origin") +
  theme_bw()



```

---

##  Peak vs Off Peak: Weekdays vs Public Holidays on Smart Cards


Morning Peak is 08:00-10:00 hrs, Evening Peak is 16:00-19:00 hrs 

```{r  warning=F, message=F}
combined_data_numeric$seq = factor(combined_data_numeric$TypeofDay, levels=c('Mon','Tue','Wed','Thu', 'Fri', 'Sat', 'Sun', 'Holiday'))
local_data <- combined_data_numeric %>% group_by(TypeofDay, seq,TimePeriod,LineO) %>% summarise(trips=sum(TOTtrips))

local_data$seq = factor(local_data$TypeofDay, levels=c('Mon','Tue','Wed','Thu', 'Fri', 'Sat', 'Sun', 'Public Holiday'))


#install.packages("viridis")


ggplot(local_data, aes(x=TimePeriod, y = trips, fill = TypeofDay))+ 
  geom_col(width=0.75, position = "dodge")+
   scale_y_continuous(labels = scales::comma)+
  scale_fill_viridis(discrete = TRUE)+
  facet_grid(~LineO) +
  ggtitle("Time Periods (aggregation: month of August)") +
  labs(x= "Time Period", y = "Total Trips")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size =10))



ggplot(local_data, aes(x=TypeofDay, y = trips, fill = TypeofDay))+ 
  geom_col( position = "dodge")+
   scale_y_continuous(labels = scales::comma)+
  scale_fill_viridis(discrete = TRUE)+
  facet_grid(TimePeriod~LineO) +
  ggtitle("Time Periods (aggregation: month of August)") +
  labs(x= "Time Period", y = "Total Trips")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size =10))
```



##  Hourly Trends: Weekdays vs Public Holidays on Tokens

The public holidays include Moharam(9), RakshaBandhan (11), Independence Day (15), Janmashtami(19), Ganesh Chaturthi (31).

```{r message=F, warning=F, echo=F}
# hourly data based on weekdays, 
library(magrittr)
library(dplyr)
hourly_day <- dailyCSTAug2022 %>% 
  mutate(weekday = lubridate::wday(calendar, label = T), 
         Date_of_Month=lubridate::day(calendar),
         TypeofDay = if_else(Date_of_Month %in% c(9,11,15,19,31),"Holiday", as.character(weekday)),
         TimePeriod = case_when(fromHr %in% c(8,9,10) ~ 'AM', fromHr %in% c(16,17,18,19) ~ 'PM', TRUE ~ 'OffPeak')) 

combined_data_numeric$seq = factor(combined_data_numeric$TypeofDay, levels=c('Mon','Tue','Wed','Thu', 'Fri', 'Sat', 'Sun', 'Holiday'))


library(ggplot2)
ggplot(combined_data_numeric %>% filter(sheet == "CST") %>% group_by(TypeofDay, seq, TimePeriod, fromHr, LineO) %>% summarize(trips=sum(TOTtrips)), aes(x = fromHr, y = trips, col = LineO, group = LineO)) + geom_line() +
  #facet_grid(LineO~seq) +
  scale_color_manual(values = c("darkgreen", "purple"))+
  facet_wrap(~seq) +
  ggtitle("Hourly Pattern (aggregation: month of August)") +
  labs(x= "Hour of the day", y = "Total Trips", col = "Line of Origin") +
  theme_bw()



```

---

##  Peak vs Off Peak: Weekdays vs Public Holidays on Tokens


Morning Peak is 08:00-10:00 hrs, Evening Peak is 16:00-19:00 hrs 

```{r  warning=F, message=F, fig.width = 12, fig.height = 6}
local_data <- combined_data_numeric %>% group_by(TypeofDay, seq,LineO, TimePeriod) %>% summarise(trips=sum(TOTtrips))
ggplot(local_data, aes(x=seq, y = trips, fill = LineO))+ 
  geom_col( alpha=0.75, position = "dodge")+
  facet_wrap(~TimePeriod) +
  scale_y_continuous(labels = scales::comma)+
  scale_fill_manual(values = c("darkgreen", "purple"))+
  ggtitle("Time Periods (aggregation: month of August)") +
  labs(x= "Line of Origin", y = "Total Trips", fill = "Line of Origin")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size =10))


```

# Peak flows on weekdays

```{r}

load("../../FullCleanData_bmrcl.Rdata") # data contains od matrix data in long format

OD_weekdays_hourly_totals <- ODMatrix_analysis %>% filter(TypeofDay %in% c("Mon"  ,   "Tue"   ,  "Wed"  ,   "Thu"    , "Fri" )) %>% group_by(fromHr) %>% 
  summarize(trips = sum(TOTtrips), avg_trips = mean(TOTtrips)) %>%
  arrange(desc(trips))

# peak hour is 9-10am and 6-7pm

od_matrix_AM_peak <- ODMatrix_analysis %>% filter(TypeofDay %in% c("Mon"  ,   "Tue"   ,  "Wed"  ,   "Thu"    , "Fri" ), fromHr == 9) %>% 
  group_by(calendar, calendar_date, fromHr) %>%
  summarize(trips=sum(TOTtrips)) %>% arrange(trips) 
peak_AM_DAY <- (od_matrix_AM_peak[nrow(od_matrix_AM_peak),1])$calendar

od_matrix_PM_peak <- ODMatrix_analysis %>% filter(TypeofDay %in% c("Mon"  ,   "Tue"   ,  "Wed"  ,   "Thu"    , "Fri" ), fromHr == 18) %>% 
  group_by(calendar, calendar_date, fromHr) %>%
  summarize(trips=sum(TOTtrips)) %>% arrange(trips) 
peak_PM_DAY <-od_matrix_PM_peak[nrow(od_matrix_AM_peak),1]$calendar

combined_peak_AM_PM_whole_month <- rbind(od_matrix_AM_peak, od_matrix_PM_peak)


od_peak_AM_peak_day <- ODMatrix_analysis %>% filter(calendar==peak_AM_DAY, fromHr == 9 )

od_peak_PM_peak_day <- ODMatrix_analysis %>% filter(calendar==peak_PM_DAY, fromHr == 18 )

#ggplot(data=combined_peak_AM_PM_whole_month, aes(y=trips, group=as.character(fromHr))) +   geom_boxplot()


odAM_peak_day_merge <- od_peak_AM_peak_day %>% group_by(Origin, Destination) %>% summarize (trips = sum(TOTtrips))
odPM_peak_day_merge <- od_peak_PM_peak_day %>% group_by(Origin, Destination) %>% summarize (trips = sum(TOTtrips))

# create matrix from peak am 

odAM_peak_day_merge %>%
  pivot_wider_profile(names_from = Destination, id_cols = Origin, values_from = trips, to_matrix = T) -> matrixAM_for_dodgr

# create matrix from peak pm 

odPM_peak_day_merge %>%
  pivot_wider_profile(names_from = Destination, id_cols = Origin, values_from = trips, to_matrix = T) -> matrixPM_for_dodgr


```


```{r calculateFlows, warning=FALSE, message=FALSE, echo=FALSE, results=F}

metro <- sf::st_read("../../Data/GIS/lines12.shp")
metro_graph <- weight_streetnet(metro, wt_profile = "foot" , id_col = "id", type_col = "highway",
                                wt_profile_file = "../../Data/GIS/wtp.json")



```


```{r}
sorted_stations <- latlong %>% arrange(abbrev) %>% mutate(OBJECTID = row_number())
from <- sorted_stations[,c("long", "lat")]
to <- sorted_stations[,c("long", "lat")]

assigned_flow_AM <- dodgr_flows_aggregate (graph = metro_graph, from = from, to = to, flows = matrixAM_for_dodgr, norm_sums = F)
assigned_flow_PM <- dodgr_flows_aggregate (graph = metro_graph, from = from, to = to, flows = matrixPM_for_dodgr, norm_sums = F)


sf_f_AM <- dodgr::dodgr_to_sf(assigned_flow_AM)
sf_f_PM <- dodgr::dodgr_to_sf(assigned_flow_PM)
#sf::st_write(sf_f_AM, "assigned_flow_AM.shp", delete_layer = T )
#sf::st_write(sf_f_PM, "assigned_flow_PM.shp", delete_layer = T )






```


```{r bufferFlows}
library(scales)
library(mapview)
# CONVERT PROJECTION

p_sf_am <- sf::st_transform(sf_f_AM, crs = 3857)
p_sf_pm <- sf::st_transform(sf_f_PM, crs = 3857)

#scale

p_sf_am$scaledFlow <- rescale(p_sf_am$flow, to = c(0,200))
p_sf_pm$scaledFlow <- rescale(p_sf_pm$flow, to = c(0,200))

#  TRY TO GET A BUFFER ON SF

library(magrittr)
library(dplyr)
buffer_f_am <- p_sf_am %>% sf::st_buffer( ., dist = .$scaledFlow, singleSide = T)
#plot(buffer_f_am$geometry)

buffer_f_pm <- p_sf_pm %>% sf::st_buffer( ., dist = .$scaledFlow, singleSide = T)
#plot(p_sf_pm$geometry)

```


## Morning Peak Hour Flows

```{r}

library(mapview) 
 # add points
 stations <- sf::st_as_sf(latlong, coords = c("long", "lat"), crs=4326)
 
 

 buffer_f_am %>% select(flow) %>% mapview::mapview(zcol = "flow", col.regions=list( "darkgreen"  , "lawngreen" , "yellow" , "orange", "red"), alpha.regions = 1,popup = F) + mapview(stations, cex = 2, label= "abbrev")

 
```

## Evening Peak Hour Flows

```{r}

library(mapview) 
 # add points
 stations <- sf::st_as_sf(latlong, coords = c("long", "lat"), crs=4326)
 
 buffer_f_pm %>% select(flow) %>% mapview::mapview(zcol = "flow", col.regions=list( "darkgreen"  , "lawngreen" , "yellow" , "orange", "red"), alpha.regions = 1,popup = F) + mapview(stations, cex = 2, label= "abbrev")


 
```
